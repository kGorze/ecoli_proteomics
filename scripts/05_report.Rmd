---
title: "Analiza Proteomiczna - UPS2 vs UPS1 Dynamic Range Benchmark"
author: "Proteomika - Projekt"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: flatly
    highlight: tango
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE,
  fig.width = 10,
  fig.height = 7,
  dpi = 150
)

# Załaduj pakiety
library(tidyverse)
library(knitr)
library(kableExtra)
library(pheatmap)
library(RColorBrewer)
```

# 1. Wprowadzenie

## 1.1 Opis projektu

Ten raport przedstawia analizę danych proteomicznych z eksperymentu **"Dynamic Range Benchmark"** z publikacji Cox et al. 2014 (DOI: [10.1074/mcp.M113.031591](https://doi.org/10.1074/mcp.M113.031591)). Dane zostały pobrane z repozytorium PRIDE (PXD000279).

## 1.2 Cel analizy

1. **Analiza różnicowa UPS2 vs UPS1** - identyfikacja białek różnicowo ekspresjonowanych
2. **Empiryczny FDR** - ocena odsetka fałszywych trafień na białkach E. coli
3. **Dokładność fold-change** - porównanie obserwowanych vs oczekiwanych zmian dla białek UPS
4. **Porównanie wariantów pipeline'u** - ocena wpływu normalizacji i imputacji

## 1.3 Opis danych

- **UPS1**: 48 rekombinowanych białek ludzkich w mieszaninie **ekwimolarnej** (5,000 fmol każde)
- **UPS2**: Te same białka w 5 grupach o różnych stężeniach:
  - Grupa A (5 białek): 50,000 fmol → **log2FC = 2.32**
  - Grupa B (10 białek): 5,000 fmol → **log2FC = -1.00**
  - Grupa C (8 białek): 500 fmol → **log2FC = -4.32**
  - Grupa D (15 białek): 50 fmol → **log2FC = -7.64**
  - Grupa E (10 białek): 5 fmol → **log2FC = -10.97**
  - Grupa F (8 białek): 0.5 fmol → **log2FC = -14.29**
- **Tło E. coli**: ~4000 białek bakteryjnych (powinny być niezmienne)

```{r load_data}
# Wczytaj wyniki
if (file.exists("../results/benchmark_results.rds")) {
  benchmark <- readRDS("../results/benchmark_results.rds")
  diff_results <- readRDS("../results/differential_results.rds")
  preproc <- readRDS("../results/preprocessing_results.rds")
  data_loaded <- TRUE
} else {
  data_loaded <- FALSE
  message("Brak plików z wynikami! Uruchom skrypty 01-04 najpierw.")
}
```

---

# 2. Dane i preprocessing

## 2.1 Statystyki surowych danych

```{r data_stats, eval=data_loaded}
# Statystyki
stats_df <- data.frame(
  Metryka = c(
    "Liczba białek (surowe)",
    "Liczba białek (po filtrowaniu)",
    "Liczba próbek UPS1",
    "Liczba próbek UPS2",
    "Białka E. coli",
    "Białka UPS (Human)",
    "% brakujących wartości"
  ),
  Wartość = c(
    nrow(preproc$raw_matrix),
    nrow(preproc$log2_filtered),
    length(preproc$ups1_cols),
    length(preproc$ups2_cols),
    sum(preproc$protein_species == "ECOLI"),
    sum(preproc$protein_species == "UPS"),
    round(mean(is.na(preproc$log2_filtered)) * 100, 1)
  )
)

kable(stats_df, caption = "Statystyki danych") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 2.2 Mapa brakujących wartości

```{r missingness_heatmap, eval=data_loaded, fig.cap="Mapa brakujących wartości (NA) w danych. Białe = brak danych."}
# Przygotuj macierz missingness
miss_matrix <- is.na(preproc$log2_filtered) * 1

# Jeśli za dużo białek, weź próbkę
if (nrow(miss_matrix) > 500) {
  set.seed(123)
  sample_idx <- sample(1:nrow(miss_matrix), 500)
  miss_matrix_plot <- miss_matrix[sample_idx, ]
} else {
  miss_matrix_plot <- miss_matrix
}

# Annotacje
annotation_col <- data.frame(
  Group = c(rep("UPS1", length(preproc$ups1_cols)), 
            rep("UPS2", length(preproc$ups2_cols))),
  row.names = c(preproc$ups1_cols, preproc$ups2_cols)
)

pheatmap(
  miss_matrix_plot,
  annotation_col = annotation_col,
  annotation_colors = list(Group = c(UPS1 = "#E41A1C", UPS2 = "#377EB8")),
  color = c("white", "black"),
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_rownames = FALSE,
  main = "Mapa brakujących wartości (NA)",
  legend = FALSE
)
```

## 2.3 Warianty pipeline'u

W analizie przetestowano dwa warianty przetwarzania:

| Wariant | Normalizacja | Imputacja |
|---------|--------------|-----------|
| **Wariant 1** | Median centering | Brak (analiza z NA) |
| **Wariant 2** | VSN (Variance Stabilizing) | Brak (Analiza na kompletnych) |

---

# 3. Analiza różnicowa UPS2 vs UPS1

## 3.1 Volcano Plot

```{r volcano_plots, eval=data_loaded, fig.height=10, fig.cap="Volcano plots dla obu wariantów. Kolory: czerwony = UPS istotne, niebieski = E. coli istotne (false positives)."}
# Funkcja do tworzenia volcano
create_volcano <- function(results_df, title) {
  results_df %>%
    mutate(
      neg_log10_pval = -log10(P.Value),
      Color = case_when(
        Species == "UPS" & Significant ~ "UPS (significant)",
        Species == "UPS" & !Significant ~ "UPS (not significant)",
        Species == "ECOLI" & Significant ~ "E. coli (FP)",
        Species == "ECOLI" & !Significant ~ "E. coli (TN)",
        TRUE ~ "Other"
      )
    ) %>%
    ggplot(aes(x = logFC, y = neg_log10_pval, color = Color)) +
    geom_point(alpha = 0.5, size = 1.5) +
    geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "grey50") +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey50") +
    scale_color_manual(values = c(
      "UPS (significant)" = "#E41A1C",
      "UPS (not significant)" = "#FDBF6F",
      "E. coli (FP)" = "#377EB8",
      "E. coli (TN)" = "#A6CEE3",
      "Other" = "grey"
    )) +
    labs(title = title, x = "log2 Fold Change", y = "-log10(p-value)") +
    theme_minimal() +
    theme(legend.position = "bottom")
}

v1_plot <- create_volcano(diff_results$results_v1, "Wariant 1: Median Normalization")
v2_plot <- create_volcano(diff_results$results_v2, "Wariant 2: VSN")

library(patchwork)
v1_plot / v2_plot
```

## 3.2 PCA

```{r pca, eval=data_loaded, fig.cap="PCA po normalizacji VSN. Wyraźna separacja grup UPS1 i UPS2."}
# PCA
complete_rows <- complete.cases(diff_results$log2_v2)
pca_matrix <- diff_results$log2_v2[complete_rows, 
                                    c(diff_results$ups1_cols, diff_results$ups2_cols)]

pca_result <- prcomp(t(pca_matrix), scale. = TRUE)
var_explained <- summary(pca_result)$importance[2, 1:2] * 100

pca_df <- data.frame(
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  Sample = rownames(pca_result$x),
  Group = c(rep("UPS1", length(diff_results$ups1_cols)), 
            rep("UPS2", length(diff_results$ups2_cols)))
)

ggplot(pca_df, aes(x = PC1, y = PC2, color = Group)) +
  geom_point(size = 4) +
  scale_color_manual(values = c("UPS1" = "#E41A1C", "UPS2" = "#377EB8")) +
  labs(
    title = "PCA - VSN Normalized Data",
    x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 1), "%)")
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## 3.3 Heatmap top 50 białek

```{r heatmap, eval=data_loaded, fig.height=12, fig.cap="Heatmap top 50 białek z najniższą p-value."}
# Top 50 białek
top_proteins <- diff_results$results_v2 %>%
  arrange(P.Value) %>%
  head(50) %>%
  pull(Protein_ID)

heatmap_data <- diff_results$log2_v2[top_proteins, 
                                      c(diff_results$ups1_cols, diff_results$ups2_cols)]

# Imputacja NA medianą wiersza
for (i in 1:nrow(heatmap_data)) {
  row_median <- median(heatmap_data[i, ], na.rm = TRUE)
  heatmap_data[i, is.na(heatmap_data[i, ])] <- row_median
}

heatmap_scaled <- t(scale(t(heatmap_data)))

annotation_col <- data.frame(
  Group = c(rep("UPS1", length(diff_results$ups1_cols)), 
            rep("UPS2", length(diff_results$ups2_cols))),
  row.names = c(diff_results$ups1_cols, diff_results$ups2_cols)
)

annotation_row <- data.frame(
  Species = diff_results$results_v2$Species[match(top_proteins, 
                                                   diff_results$results_v2$Protein_ID)],
  row.names = top_proteins
)

pheatmap(
  heatmap_scaled,
  annotation_col = annotation_col,
  annotation_row = annotation_row,
  annotation_colors = list(
    Group = c(UPS1 = "#E41A1C", UPS2 = "#377EB8"),
    Species = c(ECOLI = "#A6CEE3", UPS = "#FDBF6F", Unknown = "grey")
  ),
  cluster_cols = FALSE,
  show_rownames = FALSE,
  color = colorRampPalette(c("#2166AC", "white", "#B2182B"))(100),
  main = "Top 50 Differential Proteins"
)
```

---

# 4. Benchmark

## 4.1 Empiryczny FDR na E. coli

Białka E. coli stanowią **idealne false positive control** - nie powinny wykazywać różnic między UPS1 a UPS2.

```{r fdr_table, eval=data_loaded}
fdr_df <- data.frame(
  Wariant = c("Median (bez imputacji)", "VSN"),
  `Białka E. coli` = c(benchmark$v1$n_ecoli, benchmark$v2$n_ecoli),
  `False Positives` = c(benchmark$v1$n_ecoli_fp, benchmark$v2$n_ecoli_fp),
  `Empiryczny FDR (%)` = c(round(benchmark$v1$empirical_fdr, 2), 
                           round(benchmark$v2$empirical_fdr, 2))
)

kable(fdr_df, caption = "Empiryczny FDR na białkach E. coli", 
      col.names = c("Wariant", "Białka E. coli", "False Positives", "Empiryczny FDR (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(which.min(fdr_df$`Empiryczny.FDR....`), bold = TRUE, color = "green")
```

```{r fdr_thresholds, eval=data_loaded}
# FDR przy różnych progach
fdr_combined <- bind_rows(
  benchmark$v1$fdr_summary %>% mutate(Wariant = "Median"),
  benchmark$v2$fdr_summary %>% mutate(Wariant = "VSN")
)

ggplot(fdr_combined, aes(x = factor(Threshold), y = Empirical_FDR_pct, fill = Wariant)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = c(1, 5), linetype = "dashed", color = c("green", "orange")) +
  labs(
    title = "Empiryczny FDR na E. coli przy różnych progach adj.P.Val",
    x = "Próg adj.P.Val",
    y = "Empiryczny FDR (%)"
  ) +
  scale_fill_manual(values = c("Median" = "#E41A1C", "VSN" = "#377EB8")) +
  theme_minimal()
```

## 4.2 Dokładność Fold-Change dla UPS

```{r fc_accuracy, eval=data_loaded}
fc_df <- data.frame(
  Wariant = c("Median (bez imputacji)", "VSN"),
  `Dopasowane UPS` = c(benchmark$v1$n_ups_matched, benchmark$v2$n_ups_matched),
  Korelacja = c(round(benchmark$v1$correlation, 3), round(benchmark$v2$correlation, 3)),
  RMSE = c(round(benchmark$v1$rmse, 2), round(benchmark$v2$rmse, 2)),
  MAE = c(round(benchmark$v1$mae, 2), round(benchmark$v2$mae, 2))
)

kable(fc_df, caption = "Dokładność fold-change dla białek UPS",
      col.names = c("Wariant", "Dopasowane UPS", "Korelacja", "RMSE", "MAE")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 4.3 Expected vs Observed Fold-Change

```{r expected_vs_observed, eval=data_loaded, fig.height=10}
plot_exp_obs <- function(ups_df, title, corr, rmse) {
  if (is.null(ups_df) || nrow(ups_df) == 0) return(NULL)
  
  group_colors <- c(A = "#E41A1C", B = "#377EB8", C = "#4DAF4A", 
                    D = "#984EA3", E = "#FF7F00")
  
  ggplot(ups_df, aes(x = Expected_log2FC, y = logFC, color = Group)) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50", size = 1) +
    geom_point(size = 3, alpha = 0.7) +
    scale_color_manual(values = group_colors) +
    annotate("text", x = -8, y = 2, 
             label = paste0("r = ", round(corr, 3), "\nRMSE = ", round(rmse, 2)),
             hjust = 0, size = 4) +
    labs(title = title, x = "Expected log2 FC", y = "Observed log2 FC") +
    coord_fixed() +
    theme_minimal()
}

p1 <- plot_exp_obs(benchmark$v1$ups_comparison, "Wariant 1: Median", 
                   benchmark$v1$correlation, benchmark$v1$rmse)
p2 <- plot_exp_obs(benchmark$v2$ups_comparison, "Wariant 2: VSN",
                   benchmark$v2$correlation, benchmark$v2$rmse)

if (!is.null(p1) && !is.null(p2)) {
  p1 / p2
} else if (!is.null(p2)) {
  p2
}
```

---

# 5. Podsumowanie i wnioski

## 5.1 Porównanie wariantów

```{r comparison_table, eval=data_loaded}
kable(benchmark$comparison, caption = "Porównanie wariantów pipeline'u") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## 5.2 Wnioski

```{r conclusions, eval=data_loaded, results='asis'}
# Określ lepszy wariant
better_fdr <- ifelse(benchmark$v1$empirical_fdr < benchmark$v2$empirical_fdr, 
                     "Wariant 1 (Median)", "Wariant 2 (VSN)")
better_rmse <- ifelse(!is.na(benchmark$v1$rmse) && !is.na(benchmark$v2$rmse) && 
                      benchmark$v1$rmse < benchmark$v2$rmse,
                     "Wariant 1 (Median)", "Wariant 2 (VSN)")

cat("### Główne obserwacje:\n\n")

cat("1. **Empiryczny FDR**: ", better_fdr, " wykazuje niższy odsetek fałszywych trafień na białkach E. coli.\n\n")

if (!is.na(benchmark$v1$rmse) && !is.na(benchmark$v2$rmse)) {
  cat("2. **Dokładność fold-change**: ", better_rmse, " lepiej odtwarza oczekiwane różnice stężeń dla białek UPS.\n\n")
}

cat("3. **Rekomendacja**: Na podstawie analizy benchmark, **", 
    ifelse(better_fdr == better_rmse, better_fdr, 
           paste0(better_fdr, " (niższy FDR) lub ", better_rmse, " (lepsza dokładność FC)")),
    "** jest rekomendowany jako bardziej wiarygodny pipeline.\n\n")

cat("### Interpretacja wyników:\n\n")
cat("- Białka E. coli powinny wykazywać **zerowy** fold-change (są tłem eksperymentu)\n")
cat("- Każde białko E. coli oznaczone jako 'istotne' to **false positive**\n")
cat("- Korelacja między oczekiwanym a obserwowanym FC dla UPS mierzy **dokładność ilościową**\n")
cat("- Idealne wyniki: FDR = 0%, korelacja = 1.0, RMSE = 0\n")
```

---

# 6. Informacje o sesji

```{r session_info}
sessionInfo()
```

---

*Raport wygenerowany: `r Sys.time()`*
